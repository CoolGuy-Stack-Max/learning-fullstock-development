name: Deploy to Aliyun ECS

on:
  push:
    branches:
      - master # 当推送到 master 分支时触发

# 优化：将共享环境变量提升到顶层，所有 jobs 均可访问
env:
  REGISTRY: ${{ secrets.CI_REGISTRY }}
  IMAGE_NAME: ${{ secrets.CI_REGISTRY }}/evan_lee_repo/images_repo_of_docker

jobs:
  build:
    runs-on: ubuntu-latest
    # environment: deployment_vars # 使用已配置的环境变量
    outputs:
      image_tag: ${{ github.sha }}

    steps:
      - name: Check IMAGE_NAME value
        run: echo ${{ env.IMAGE_NAME }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Cache Docker layers
        uses: actions/cache@v3 # buildx 本地 layer cache
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Login to Alibaba Cloud Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.CI_REGISTRY }} # 阿里云 Docker Registry 地址
          username: ${{ secrets.DOCKER_USERNAME }} # 阿里云 Docker 用户名
          password: ${{ secrets.DOCKER_PASSWORD }} # 阿里云 Docker 密码

      - name: Check IMAGE_NAME value again
        run: echo ${{ env.IMAGE_NAME }}

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: ./server # 设置构建上下文
          file: ./k8s/docker/server/Dockerfile # 设置 Dockerfile 路径
          push: true # 推送镜像到 Docker Registry
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.IMAGE_NAME }}:latest
          # cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache # 启用缓存
          # cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max # 启用缓存
      - name: List Docker Images
        run: docker images
  # --------------------------------------------------
  # Job 2: 部署到阿里云服务器
  # --------------------------------------------------
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    # environment: deployment_vars

    steps:
      # 步骤 1: 签出代码，以便可以访问到配置文件
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤 2: 核心修复 - 使用 SCP 将配置文件复制到服务器
      - name: Copy deployment files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_ECS_HOST }}
          username: ${{ secrets.ALIYUN_ECS_USERNAME }}
          password: ${{ secrets.ALIYUN_ECS_PASSWORD }}
          port: ${{ secrets.ALIYUN_ECS_PORT || 22 }}
          # 要复制的源文件，支持多个
          source: "k8s/docker/server/docker-compose.yml,k8s/docker/server/server-config.env"
          # 部署到服务器的目标目录
          target: "/opt/my-admin-order"

      # 步骤 3: 连接到服务器并执行部署命令
      - name: Deploy services via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_ECS_HOST }}
          username: ${{ secrets.ALIYUN_ECS_USERNAME }}
          password: ${{ secrets.ALIYUN_ECS_PASSWORD }}
          port: ${{ secrets.ALIYUN_ECS_PORT || 22 }}
          script: |
            # --- 准备环境变量 ---
            export DEPLOY_DIR="/opt/my-admin-order"
            export COMPOSE_FILE_PATH="${DEPLOY_DIR}/docker-compose.yml"
            export IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
            export FULL_IMAGE_NAME="${{ env.IMAGE_NAME }}:${IMAGE_TAG}"

            echo "-----> Starting deployment for image: ${FULL_IMAGE_NAME}"

            # --- 动态更新镜像版本 ---
            # 文件已由 scp-action 复制，此步骤现在可以正常工作
            echo "-----> Updating image tag in compose file..."
            sed -i "s|image:.*|image: ${FULL_IMAGE_NAME}|g" ${COMPOSE_FILE_PATH}

            echo "-----> Compose file updated. New content:"
            cat ${COMPOSE_FILE_PATH}

            # --- 执行部署 ---
            cd $DEPLOY_DIR

            echo "-----> Logging in to Docker Registry..."
            docker login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}" ${{ env.REGISTRY }}

            echo "-----> Pulling the new image from registry..."
            docker pull $FULL_IMAGE_NAME

            echo "-----> Deploying services with docker-compose..."
            docker-compose -f ${COMPOSE_FILE_PATH} up --force-recreate --remove-orphans -d

            # --- 清理工作 ---
            echo "-----> Pruning old docker images..."
            docker image prune -a --filter="label!=unittest" -f

            echo "-----> Deployment Successful!"
