name: Deploy to Kubernetes

on:
  push:
    branches:
      - master # 当推送到 master 分支时触发

jobs:
  build:
    runs-on: ubuntu-latest
    # environment: deployment_vars # 使用已配置的环境变量
    env:
      IMAGE_NAME: ${{ secrets.CI_REGISTRY }}/evan_lee_repo/images_repo_of_docker # 使用阿里云仓库路径

    steps:
      - name: Check IMAGE_NAME value
        run: echo ${{ env.IMAGE_NAME }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Cache Docker layers
        uses: actions/cache@v3 # buildx 本地 layer cache
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Login to Alibaba Cloud Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.CI_REGISTRY }} # 阿里云 Docker Registry 地址
          username: ${{ secrets.CI_REGISTRY_USER }} # 阿里云 Docker 用户名
          password: ${{ secrets.CI_REGISTRY_PASSWORD }} # 阿里云 Docker 密码

      - name: Check IMAGE_NAME value again
        run: echo ${{ env.IMAGE_NAME }}

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: ./k8s/docker/server # 设置构建上下文
          file: ./k8s/docker/server/Dockerfile # 设置 Dockerfile 路径
          push: true # 推送镜像到 Docker Registry
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache # 启用缓存
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max # 启用缓存

